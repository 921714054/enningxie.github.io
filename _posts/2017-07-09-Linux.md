---
layout: post
title: the Way to Linux
date: 2017-07-09
categories: blog
tags: [Linux]
description: Linux升级之路
---

## 1. 从添加用户开始谈起

Linux中添加一个新的用户，可以使用`adduser`或`useradd`命令。

在Ubuntu中`adduser`是一个脚本，而`useradd`是一个二进制程序，前者对后者进行了封装，更加智能。

但在CentOS中`adduser`和`useradd`完全相同，前者只是一个符号连接。

注意的是，`useradd`在任何Linux发行版都是一样的，所以我们最好牢记它。

添加一个新用户最简单的方法：  
`# useradd enningxie`（注意需要root权限）

上述命令执行后，系统为我们创建了一个新的用户，用户名为“enningxie”。系统在创建过程中帮我们设置好了很多的默认值，包括：创建一个唯一的UID；添加一个与用户名相同的用户组和一个唯一的GID，并将用户设置为该组；在/home目录下创建一个与用户名同名的目录；设置shell为/bin/bash。唯一还没有设置的就是密码了，使用`passwd`命令可以做到这点。

**拓展部分**：

> `usermod`用于修正某些细微的配置参数，比如希望使用一个不同的shell；  
`userdel`用于删除某个用户，`-r`参数选项，把用户的home目录一同删除；  
用户组的管理同用户的管理类似，相似的命令有：`groupadd`、`groupmod`、`groupdel`、`gpasswd`。

## 2. 关于sudo的用法

Linux的用户除了root就是普通用户，而普通用户的权限非常低，就连向系统安装软件的权利都没有。很多时候系统管理员为了能让普通用户具备一点root用户的特权，就可以赋给用户被称为sudo的特权。

给某个用户赋予sudo特权，实际上就是更改/etc/sudoers文件中的内容。在该文件中有一行：  
`root ALL=(ALL) ALL`  
它的含义是说root用户可以使用sudo特权以root权限执行任何命令。

现在，我们想要为一个用户赋予sudo特权，我们可以参照上述写法：  
`enningxie ALL=(ALL) ALL`  

赋予一个用户组的所有用户sudo特权：  
`%groupname ALL=(ALL) ALL`

特殊写法：  
`%groupname ALL=(ALL) NOPASSWD:ALL`  
关键字NOPASSWD，可以使得不需要输入密码即可拥有root权限。这个NOPASSWD并不仅仅作用于用户组，对于我们之前所说的单个用户授权的方法也是有效的。但是这种写法会导致权限过大，（不输密码感觉有点不负责任的样子），所以不建议使用。

`%users ALL=/sbin/mount /mnt/cdrom, /sbin/unmount /mnt/cdrom`  
这一行主要描述了users用户组，可以执行：  
`sudo mount /mnt/cdrom`  
`sudo unmount /mnt/cdrom`  
除了这两条命令之外，其它的都会被Linux系统拒绝。

`%users ALL=(ALL) ALL,!/usr/sbin/adduser,!/usr/sbin/useradd`  
这一行使得users用户组无法使用sudo特权给系统添加新的用户。

新建用户之后，会涉及到用户之间的切换问题；用户间切换使用`su`命令。  
`su`命令就是做临时用户切换的，默认是切换到root用户。`su`在做用户切换的时候也会提示输入密码，但是与`sudo`需要输入自己的密码不同，`su`要求的是输入目标用户密码，退出切换后的用户用`exit`。  
如果不给`su`任何参数，那么它默认切换的是root用户，同时不会更改当前所在的目录。加上`-`参数后，即`su -`，则会改变当前目录到目标用户的home目录。例如：`su enningxie -`，就会立即切换到enningxie用户下，同时当前目录变更为/home/enningxie。  
使用`su`命令，管理员可以任意切换成任何用户，这是给管理员在管理上带来的很大的便利。然而普通用户的隐私，在管理员面前也就完全公开了。  
有意思的是，对于被赋予sudo特权的普通用户来说可以通过执行`sudo su -`跳过root密码，反之用自己的密码进入root用户（tips）。避免这种问题的发生，应该在/etc/sudoers文件中明确禁止`su`被`sudo`特权执行。

## 3. who am i

当用户多了的时候，你又在频繁切换用户，你会想知道最初使用的用户是什么，当前的用户又是什么。专业术语会给出：实际用户（UID）和有效用户（EUID，即Effective UID）。

> 所谓实际用户是指用户登录时所使用的用户，所以在整个登录会话中，实际用户是不会发生变化的；而有效用户则是指当前执行操作的用户，这个是能够利用`su`或`sudo`命令进行任意切换的。一般情况下，实际用户和有效用户是相同的，只有发生用户身份切换的时候才会出现差异。

对于那些经常需要切换用户的系统管理员来说，搞清楚当前使用的是什么身份的用户是一件不太容易的事情，但是对于某些shell脚本，或许需要特别的用户才能执行，那么就需要利用`whoami`（查看有效用户）这个命令来搞清楚执行它的用户是谁；还有一些shell脚本可能不太喜欢被人欺骗，一定要某个特别的用户才能执行，即便是使用`su`切换的都不行，那么需要使用`who am i`（查看实际用户）这个命令来确认。

## 4. 文件和它与权限的关系

**目录与文件**

Linux的文件组织方式是从“/”开始的一颗树，所以“/”也被称为根目录。

在Linux中查看文件和目录的命令是`ls`，它会列出当前目录下的所有目录和文件。

Linux中用颜色来区分目录和文件的，一般的，蓝色代表目录，其它颜色代表文件。

**文件属性和权限**

在Linux系统中，每个文件都会有一个特定的拥有者（一般是创建它的用户）和所属用户组，这是属于它的固有属性。文件可以利用这两个固有属性来规定它的拥有者或者其所属用户组内的用户是否拥有对它的访问权利，即读、写和执行的权利。此外，为了提高适应性，文件还规定了其他不相关人等，也就是第三个固有属性，对它的读、写和执行的权利。这三个固有属性和三个权利合起来，就构成了文件的针对系统中所有用户的访问控制。

`-rwxr-xr-x 1 root root  27776  Apr 17 2012 arch`  
文件属性展示结构，依次分别是：文件类型和权限、连接数、拥有者、所属用户组、文件大小、最后修改日期、文件名。

`-rwxr-xr-x`  
第一个字符用于描述文件类型，可能的取值是：-、d、l、b、c、s和p。“-”代表这是一个普通文件；“d”代表这是一个目录；“l”代表这一个软连接，硬连接；“b”和“c”都代表着设备文件，“b”是块设备，如磁盘等保存大块数据的设备，“c”是字符设备，如鼠标、键盘等需要连续串行读写的设备；“s”代表是套接字（socket）文件；“p”是命名管道文件。  
余下的部分则对应着不同用户群体的读、写和执行权限。

Linux的权限控制很明晰，当某个用户需要访问某个文件时，系统就读取这个文件的属性和权限信息与当前用户的UID和GID进行对比，来确定当前用户是文件的拥有者还是与其所属用户组同组。然后根据这些对比结果和用户所执行的动作来判断是否满足权限要求。这样也就引出了文件权限与命令的一些关系，因为Linux系统中一个文件是否是可执行文件是通过属性来决定的，而不是拓展名。

对于目录，“x”权限可以控制用户是否能够打开它，只有具备“x”权限的用户才能打开这个目录。而如果要想使用`ls`命令来查看这个目录下的文件列表，则必须拥有“r”权限，否则即便能够进入，也无济于事。那么想要在目录中创建文件就需要拥有“w”权限了。

对于其它类型的文件，若想读取则需要“r”权限，若想能够使用编辑器编辑，就必须同时具备“r”和“w”这两个权限。如果一个文件是shell脚本或者其它可执行文件，要能够被执行，应当具备“x”权限。

文件名前面带有“.”的即是隐藏文件，而实际上文件的隐藏属性就是在文件名前添加“.”。

**关于文件连接的问题**

文件连接的问题，也就是上述文件属性中的连接数属性的延伸。要搞清楚这个属性就要搞清楚Linux保存文件的方法。Linux所使用的文件系统是一种基于inode的文件系统。每一个新创建的文件都会被分配一个inode，且每个文件都有一个唯一的inode编号。我们可以将inode简单理解成一个指针，它指向的是文件所在磁盘中的物理位置。系统是通过inode定位每一个文件的，而不是通过文件名。所以通常情况下，为了提高文件系统的执行效率，访问过的文件的inode会被缓存在内存中。那么连接数这个属性其实就是inode的引用计数。为什么要增加这个引用计数呢？原因就在于Linux允许一个文件拥有多个名字。也就是说，文件名只是相当于inode的一次引用。

我们大多数时候所见到的“连接数”都是1，这说明大多数文件都只有一个名字。那么在什么时候文件会有多个名字呢？在使用`ln`命令建立文件连接的时候。`ln`命令可以建立两种文件连接：硬连接和软连接，其中软连接也叫做符号连接。其实软连接不是真正的连接，与Windows中的快捷方式类似，只是一个普通的文件，需要额外增加一个“-s”命令选项来创建。例如：  
`ln -s /bin/bash sh`  
就会创建一个新的软连接sh指向/bin/bash；  
软连接的文件属性和目标文件属性完全不同，按照系统设计，软连接也要占据一个新的inode。也就是说软连接是一个新的文件，不影响inode的引用计数。  
不使用“-s”命令选项创建的就是硬连接。例如：  
`ln /bin/bash bash`  
就会创建一个名为bash的硬连接到/bin/bash。  
硬连接的属性跟目标文件的属性完全相同，因为引用的是相同的inode，仅仅将inode的引用计数进行了+1操作。  
硬连接直接引用了目标文件的inode，它的所有属性也都引用进来了。

> 输入删除文件连接的目标文件，则软连接（快捷方式）会失效，而硬连接则仅是“连接数”-1。  
软连接可以创建在任何位置，包括网络，而硬连接则不行，目标文件与连接文件必须在同一个磁盘分区内。  
软硬连接在使用的时候区别不大，都相当于是一个文件具有不同的路径和文件名。
